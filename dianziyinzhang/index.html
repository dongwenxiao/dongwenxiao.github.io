<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电子印章生成器</title>
    <style>
        :root {
            --bg-color: #f5f5f0;
            --panel-bg: #ffffff;
            --text-color: #333;
            --border-color: #ddd;
            --primary-color: #d93025; /* Seal red */
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            color: var(--text-color);
            overflow: hidden;
        }

        /* Left Panel - Canvas */
        .preview-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fdfdf9; /* Slightly warmer bg for paper feel */
            position: relative;
        }

        canvas {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background-color: transparent;
            border-radius: 4px;
        }

        /* Right Panel - Config */
        .config-panel {
            width: 400px;
            background-color: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0,0,0,0.02);
        }

        h2 {
            font-size: 18px;
            margin-bottom: 15px;
            margin-top: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
        }

        h2:first-child {
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 100px;
            font-size: 14px;
            color: #555;
            flex-shrink: 0;
        }

        .form-group input, .form-group select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Slider Wrapper */
        .input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-wrapper input[type="range"] {
            flex: 1;
            cursor: pointer;
        }
        .input-wrapper input[type="number"] {
            width: 60px;
            flex: none;
        }

        /* Color Picker */
        .color-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        .color-preview {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
        }
        .color-wrapper input[type="text"] {
            flex: 1;
        }
        .color-wrapper input[type="color"] {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 1px;
            opacity: 0;
            cursor: pointer;
        }

        /* Custom Scrollbar */
        .config-panel::-webkit-scrollbar {
            width: 6px;
        }
        .config-panel::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>

    <div class="preview-area">
        <canvas id="sealCanvas" width="600" height="600" style="width: 300px; height: 300px;"></canvas>
    </div>

    <div class="config-panel">
        <h2>全局配置</h2>
        <div class="form-group">
            <label>旋转角度:</label>
            <input type="number" id="rotation" value="0" data-min="-180" data-max="180" data-step="1">
        </div>
        <div class="form-group">
            <label>印章颜色:</label>
            <div class="color-wrapper">
                <input type="text" id="primaryColorText" value="#cf0d0d">
                <div class="color-preview" id="primaryColorPreview" style="background-color: #cf0d0d;"></div>
                <input type="color" id="primaryColor" value="#cf0d0d">
            </div>
        </div>

        <h2>公司配置</h2>
        <div class="form-group">
            <label>公司名称:</label>
            <input type="text" id="companyName" value="北京猎原世奇科技有限公司">
        </div>

        <h2>字体配置</h2>
        <div class="form-group">
            <label>字体名称:</label>
            <select id="fontFamily">
                <option value="SimSun">加载中...</option>
            </select>
        </div>
        <div class="form-group">
            <label>字体粗细:</label>
            <input type="number" id="fontWeight" value="400" data-min="100" data-max="900" data-step="100">
        </div>
        <div class="form-group">
            <label>字体大小:</label>
            <input type="number" id="fontSize" value="41" data-min="10" data-max="100" data-step="1">
        </div>
        <div class="form-group">
            <label>文字缩放 X:</label>
            <input type="number" step="0.1" id="scaleX" value="0.9" data-min="0.1" data-max="3" data-step="0.1">
        </div>
        <div class="form-group">
            <label>文字缩放 Y:</label>
            <input type="number" step="0.1" id="scaleY" value="1.1" data-min="0.1" data-max="3" data-step="0.1">
        </div>
        <div class="form-group">
            <label>字间距:</label>
            <input type="number" step="0.1" id="spacing" value="5.1" data-min="-10" data-max="20" data-step="0.1">
        </div>
        <div class="form-group">
            <label>中文文字填充:</label>
            <input type="number" id="textMargin" value="45" title="距离边框的距离" data-min="0" data-max="100" data-step="1">
        </div>

        <h2>小字配置</h2>
        <div class="form-group">
            <label>小字:</label>
            <input type="text" id="subText" value="1101051235065">
        </div>
        <div class="form-group">
            <label>小字字体大小:</label>
            <input type="number" id="subFontSize" value="16" data-min="5" data-max="50" data-step="1">
        </div>
        <div class="form-group">
            <label>小字字体名称:</label>
            <select id="subFontFamily">
                <option value="SimHei">加载中...</option>
            </select>
        </div>
        <div class="form-group">
            <label>小字粗细:</label>
            <input type="number" id="subFontWeight" value="400" data-min="100" data-max="900" data-step="100">
        </div>
        <div class="form-group">
            <label>小字缩放 X:</label>
            <input type="number" step="0.1" id="subScaleX" value="1.2" data-min="0.1" data-max="3" data-step="0.1">
        </div>
        <div class="form-group">
            <label>小字缩放 Y:</label>
            <input type="number" step="0.1" id="subScaleY" value="1.1" data-min="0.1" data-max="3" data-step="0.1">
        </div>
        <div class="form-group">
            <label>小字字间距:</label>
            <input type="number" step="0.1" id="subSpacing" value="0.7" data-min="-5" data-max="20" data-step="0.1">
        </div>
        <div class="form-group">
            <label>小字填充:</label>
            <input type="number" id="subTextMargin" value="13" title="距离底部的距离" data-min="0" data-max="100" data-step="1">
        </div>

        <h2>星形配置</h2>
        <div class="form-group">
            <label>星形大小:</label>
            <input type="number" id="starSize" value="24" data-min="0" data-max="100" data-step="1">
        </div>

        <h2>仿真配置</h2>
        <div class="form-group">
            <label>密度:</label>
            <input type="number" id="noiseDensity" value="0" data-min="0" data-max="10000" data-step="100">
        </div>
        <div class="form-group">
            <label>最小宽度:</label>
            <input type="number" id="minWidth" value="1" data-min="1" data-max="20" data-step="1">
        </div>
        <div class="form-group">
            <label>最大宽度:</label>
            <input type="number" id="maxWidth" value="3" data-min="1" data-max="20" data-step="1">
        </div>
        <div class="form-group">
            <label>最小高度:</label>
            <input type="number" id="minHeight" value="1" data-min="1" data-max="20" data-step="1">
        </div>
        <div class="form-group">
            <label>最大高度:</label>
            <input type="number" id="maxHeight" value="3" data-min="1" data-max="20" data-step="1">
        </div>
    </div>

    <script>
        const canvas = document.getElementById('sealCanvas');
        const ctx = canvas.getContext('2d');
        
        // Configuration State
        const config = {
            rotation: document.getElementById('rotation'),
            primaryColor: document.getElementById('primaryColorText'),
            companyName: document.getElementById('companyName'),
            fontFamily: document.getElementById('fontFamily'),
            fontWeight: document.getElementById('fontWeight'),
            fontSize: document.getElementById('fontSize'),
            scaleX: document.getElementById('scaleX'),
            scaleY: document.getElementById('scaleY'),
            spacing: document.getElementById('spacing'),
            textMargin: document.getElementById('textMargin'),
            
            subText: document.getElementById('subText'),
            subFontSize: document.getElementById('subFontSize'),
            subFontFamily: document.getElementById('subFontFamily'),
            subFontWeight: document.getElementById('subFontWeight'),
            subScaleX: document.getElementById('subScaleX'),
            subScaleY: document.getElementById('subScaleY'),
            subSpacing: document.getElementById('subSpacing'),
            subTextMargin: document.getElementById('subTextMargin'),
            
            starSize: document.getElementById('starSize'),
            
            noiseDensity: document.getElementById('noiseDensity'),
            minWidth: document.getElementById('minWidth'),
            maxWidth: document.getElementById('maxWidth'),
            minHeight: document.getElementById('minHeight'),
            maxHeight: document.getElementById('maxHeight'),
        };

        // Attach listeners
        Object.values(config).forEach(input => {
            input.addEventListener('input', drawSeal);
        });

        // Initialize Sliders
        document.querySelectorAll('input[type="number"]').forEach(numInput => {
            if (!numInput.dataset.min) return;

            const wrapper = document.createElement('div');
            wrapper.className = 'input-wrapper';
            
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.min = numInput.dataset.min;
            slider.max = numInput.dataset.max;
            slider.step = numInput.dataset.step || 1;
            slider.value = numInput.value;
            
            numInput.parentNode.insertBefore(wrapper, numInput);
            wrapper.appendChild(slider);
            wrapper.appendChild(numInput);
            
            slider.addEventListener('input', () => {
                numInput.value = slider.value;
                drawSeal();
            });
            numInput.addEventListener('input', () => {
                slider.value = numInput.value;
            });
        });

        // Initialize Color Picker
        const colorText = document.getElementById('primaryColorText');
        const colorPicker = document.getElementById('primaryColor');
        const colorPreview = document.getElementById('primaryColorPreview');
        
        colorPreview.addEventListener('click', (e) => {
            e.stopPropagation();
            colorPicker.click();
        });
        
        colorPicker.addEventListener('input', () => {
            colorText.value = colorPicker.value;
            colorPreview.style.backgroundColor = colorPicker.value;
            drawSeal();
        });
        
        colorText.addEventListener('input', () => {
            if (/^#[0-9A-Fa-f]{6}$/.test(colorText.value)) {
                colorPicker.value = colorText.value;
                colorPreview.style.backgroundColor = colorText.value;
                drawSeal();
            }
        });

        // 字体中文名称映射
        const fontNameMap = {
            'SimSun': '宋体',
            'SimHei': '黑体',
            'Microsoft YaHei': '微软雅黑',
            'KaiTi': '楷体',
            'FangSong': '仿宋',
            'STSong': '华文宋体',
            'STHeiti': '华文黑体',
            'STKaiti': '华文楷体',
            'STFangsong': '华文仿宋',
            'PingFang SC': '苹方-简',
            'Songti SC': '宋体-简',
            'Heiti SC': '黑体-简',
            'Kaiti SC': '楷体-简',
            'Arial': 'Arial',
            'Times New Roman': 'Times New Roman',
            'Helvetica': 'Helvetica',
            'Helvetica Neue': 'Helvetica Neue',
            'serif': '衬线字体',
            'sans-serif': '无衬线字体',
            'monospace': '等宽字体'
        };

        function isFontAvailable(fontName) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const text = '中文ABCabc123';
            
            context.font = '72px monospace';
            const baselineWidth = context.measureText(text).width;
            
            context.font = `72px "${fontName}", monospace`;
            const testWidth = context.measureText(text).width;
            
            return baselineWidth !== testWidth;
        }

        // 动态读取系统字体
        async function loadSystemFonts() {
            const fontFamilySelect = document.getElementById('fontFamily');
            const subFontFamilySelect = document.getElementById('subFontFamily');
            
            let availableFonts = [];
            
            // 尝试使用 Font Access API (Chrome 103+)
            if ('queryLocalFonts' in window) {
                try {
                    const fonts = await window.queryLocalFonts();
                    // 去重并排序
                    const fontFamilies = [...new Set(fonts.map(font => font.family))].sort();
                    availableFonts = fontFamilies;
                    console.log('使用 Font Access API 读取到', availableFonts.length, '个字体');
                } catch (err) {
                    console.log('Font Access API 不可用:', err.message);
                }
            }
            
            // 如果 API 不可用或没有权限，使用预定义列表
            if (availableFonts.length === 0) {
                const commonFonts = [
                    'Arial',
                    'Times New Roman',
                    'Courier New',
                    'Georgia',
                    'Verdana',
                    'Helvetica',
                    'Helvetica Neue',
                    // 中文字体
                    'SimSun',
                    'SimHei',
                    'Microsoft YaHei',
                    'KaiTi',
                    'FangSong',
                    'STSong',
                    'STHeiti',
                    'STKaiti',
                    'STFangsong',
                    'PingFang SC',
                    'Songti SC',
                    'Heiti SC',
                    'Kaiti SC',
                    // 通用字体族
                    'serif',
                    'sans-serif',
                    'monospace'
                ];
                
                // 检测哪些字体可用
                availableFonts = commonFonts.filter(font => {
                    if (['serif', 'sans-serif', 'monospace'].includes(font)) {
                        return true;
                    }
                    return isFontAvailable(font);
                });
                console.log('使用备用方案，检测到', availableFonts.length, '个字体');
            }
            
            // 清空下拉框
            fontFamilySelect.innerHTML = '';
            subFontFamilySelect.innerHTML = '';
            
            // 填充下拉框
            availableFonts.forEach(font => {
                const displayName = fontNameMap[font] || font;
                
                const option1 = document.createElement('option');
                option1.value = font;
                option1.textContent = displayName;
                option1.style.fontFamily = font;
                fontFamilySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = font;
                option2.textContent = displayName;
                option2.style.fontFamily = font;
                subFontFamilySelect.appendChild(option2);
            });
            
            
            // 智能选择默认字体
            // 检测操作系统
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            
            // 主字体（公司名称）
            let defaultFont;
            if (isMac) {
                // macOS: 优先选择 Songti SC（宋体-简），其次 SimSun，再次包含"宋"的字体
                defaultFont = availableFonts.find(f => f === 'Songti SC') ||
                             availableFonts.find(f => f === 'SimSun') ||
                             availableFonts.find(f => f.includes('宋') || f.includes('Song')) ||
                             availableFonts[0];
            } else {
                // Windows: 优先选择 SimSun（宋体），其次包含"宋"的字体
                defaultFont = availableFonts.find(f => f === 'SimSun') ||
                             availableFonts.find(f => f.includes('宋') || f.includes('Song')) ||
                             availableFonts[0];
            }
            if (defaultFont) {
                fontFamilySelect.value = defaultFont;
            }
            
            // 小字字体（编号）
            let defaultSubFont;
            if (isMac) {
                // macOS: 优先选择 Heiti SC（黑体-简），其次 SimHei，再次包含"黑"的字体
                defaultSubFont = availableFonts.find(f => f === 'Heiti SC') ||
                                availableFonts.find(f => f === 'SimHei') ||
                                availableFonts.find(f => f.includes('黑') || f.includes('Hei')) ||
                                availableFonts[0];
            } else {
                // Windows: 优先选择 SimHei（黑体），其次包含"黑"的字体
                defaultSubFont = availableFonts.find(f => f === 'SimHei') ||
                                availableFonts.find(f => f.includes('黑') || f.includes('Hei')) ||
                                availableFonts[0];
            }
            if (defaultSubFont) {
                subFontFamilySelect.value = defaultSubFont;
            }
            
            // 设置完默认字体后立即绘制
            drawSeal();
        }

        // 加载字体
        loadSystemFonts();

        function drawSeal() {
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = 140; // Base radius for the seal circle
            // Use configured color
            const primaryColor = config.primaryColor.value; 

            ctx.clearRect(0, 0, width, height);
            
            // Reset composite operation
            ctx.globalCompositeOperation = 'source-over';
            
            // Add ink bleed effect
            ctx.shadowColor = primaryColor;
            ctx.shadowBlur = 2;

            ctx.save();
            // Apply Rotation
            ctx.translate(centerX, centerY);
            ctx.rotate(parseInt(config.rotation.value) * Math.PI / 180);
            ctx.translate(-centerX, -centerY);

            // 1. Draw Outer Circle (Rough)
            drawRoughCircle(ctx, centerX, centerY, radius, primaryColor, 5);

            // 2. Draw Star
            drawStar(centerX, centerY, parseInt(config.starSize.value) * 2, primaryColor);

            // 3. Draw Company Name (Top Arc)
            drawCurvedText(
                config.companyName.value,
                centerX,
                centerY,
                radius,
                'top',
                {
                    font: config.fontWeight.value + ' ' + config.fontSize.value + 'px ' + config.fontFamily.value,
                    fontSize: parseInt(config.fontSize.value),
                    scaleX: parseFloat(config.scaleX.value),
                    scaleY: parseFloat(config.scaleY.value),
                    spacing: parseFloat(config.spacing.value),
                    margin: parseInt(config.textMargin.value),
                    color: primaryColor
                }
            );

            // 4. Draw Sub Text (Bottom Arc)
            drawCurvedText(
                config.subText.value,
                centerX,
                centerY,
                radius,
                'bottom',
                {
                    font: config.subFontWeight.value + ' ' + config.subFontSize.value + 'px ' + config.subFontFamily.value,
                    fontSize: parseInt(config.subFontSize.value),
                    scaleX: parseFloat(config.subScaleX.value),
                    scaleY: parseFloat(config.subScaleY.value),
                    spacing: parseFloat(config.subSpacing.value),
                    margin: parseInt(config.subTextMargin.value),
                    color: primaryColor
                }
            );
            
            // Restore context to undo rotation for noise (optional, but good for static noise)
            ctx.restore();

            // Remove shadow for noise
            ctx.shadowBlur = 0;

            // 5. Apply Noise / Simulation
            applyNoise();
        }

        function drawRoughCircle(ctx, x, y, radius, color, lineWidth) {
            ctx.save();
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            
            // Draw main circle with slight jitter
            const passes = 3;
            for(let i=0; i<passes; i++) {
                ctx.beginPath();
                const r = radius + (Math.random() - 0.5) * 1.5;
                const ox = (Math.random() - 0.5) * 1.5;
                const oy = (Math.random() - 0.5) * 1.5;
                ctx.arc(x + ox, y + oy, r, 0, Math.PI * 2);
                ctx.stroke();
            }
            ctx.restore();
        }

        function drawStar(cx, cy, size, color) {
            ctx.save();
            ctx.fillStyle = color;
            ctx.translate(cx, cy);
            ctx.beginPath();
            // Add slight random rotation for realism
            ctx.rotate((Math.random() - 0.5) * 0.05);
            for (let i = 0; i < 5; i++) {
                ctx.lineTo(Math.cos((18 + i * 72) * Math.PI / 180) * size,
                           -Math.sin((18 + i * 72) * Math.PI / 180) * size);
                ctx.lineTo(Math.cos((54 + i * 72) * Math.PI / 180) * size / 2.5,
                           -Math.sin((54 + i * 72) * Math.PI / 180) * size / 2.5);
            }
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }

        drawCurvedText = function(text, cx, cy, radius, position, options) {
            if (!text) return;
            ctx.save();
            ctx.translate(cx, cy);
            ctx.font = options.font;
            ctx.fillStyle = options.color;
            ctx.textBaseline = 'alphabetic'; 
            ctx.textAlign = 'center';

            const totalChars = text.length;
            const charWidth = options.fontSize * 0.8 + options.spacing * 4;
            const anglePerChar = charWidth / radius;
            const totalArc = (totalChars - 1) * anglePerChar;
            
            let startAngle;
            let step;
            
            if (position === 'top') {
                startAngle = -Math.PI / 2 - totalArc / 2;
                step = anglePerChar;
            } else {
                startAngle = Math.PI / 2 + totalArc / 2;
                step = -anglePerChar;
            }
            
            const textRadius = radius - options.margin;

            for (let i = 0; i < totalChars; i++) {
                const char = text[i];
                const angle = startAngle + i * step;
                
                ctx.save();
                
                if (position === 'top') {
                    // Top: Tops point Outward
                    ctx.rotate(angle + Math.PI / 2);
                    ctx.translate(0, -textRadius);
                } else {
                    // Bottom: Tops point Inward (Flipped)
                    // Rotate so Y points Down (angle - PI/2)
                    // Translate positive Y (Down) to reach bottom
                    ctx.rotate(angle - Math.PI / 2);
                    ctx.translate(0, textRadius);
                }
                
                ctx.scale(options.scaleX, options.scaleY);
                
                // Slight random offset
                const ox = (Math.random() - 0.5) * 0.5;
                const oy = (Math.random() - 0.5) * 0.5;
                ctx.fillText(char, ox, oy);
                
                ctx.restore();
            }
            ctx.restore();
        }

        function applyNoise() {
            const density = parseInt(config.noiseDensity.value);
            if (density <= 0) return;

            const minW = parseInt(config.minWidth.value);
            const maxW = parseInt(config.maxWidth.value);
            const minH = parseInt(config.minHeight.value);
            const maxH = parseInt(config.maxHeight.value);
            
            ctx.save();
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fillStyle = 'rgba(0,0,0,1)';
            
            const w = canvas.width;
            const h = canvas.height;
            const boxSize = 320;
            const startX = (w - boxSize) / 2;
            const startY = (h - boxSize) / 2;

            for (let i = 0; i < density; i++) {
                const x = startX + Math.random() * boxSize;
                const y = startY + Math.random() * boxSize;
                const rw = minW + Math.random() * (maxW - minW);
                const rh = minH + Math.random() * (maxH - minH);
                
                ctx.fillRect(x, y, rw, rh);
            }
            ctx.restore();
        }
        
    </script>
</body>
</html>
